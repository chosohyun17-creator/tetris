<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¡°ì†Œí˜„ì˜ í…ŒíŠ¸ë¦¬ìŠ¤ - ì»¨íŠ¸ë¡¤ í†µí•© ë²„ì „</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            overflow: hidden;
            touch-action: manipulation;
        }

        .game-container {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            background-color: #34495e;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        #game-board {
            --cell-size: min(25px, 6vw);
            width: calc(var(--cell-size) * 10);
            height: calc(var(--cell-size) * 20);
            border: 4px solid #2980b9;
            background-color: #1c2833;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(20, 1fr);
        }

        .block { box-sizing: border-box; border: 1px solid rgba(255,255,255,0.1); }
        .I { background-color: #00FFFF; }
        .O { background-color: #FFFF00; }
        .T { background-color: #800080; }
        .S { background-color: #00FF00; }
        .Z { background-color: #FF0000; }
        .J { background-color: #0000FF; }
        .L { background-color: #FF7F00; }

        .info-panel { width: 100px; display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
        .game-title { margin: 0; color: #f1c40f; font-size: 1.1em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

        #next-block {
            width: 60px; height: 60px;
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
            border: 2px solid #5499c7; background-color: #1c2833;
        }
        .next-cell { border: 1px solid rgba(255,255,255,0.05); }

        /* ì¡°ì‘ ì»¨íŠ¸ë¡¤ëŸ¬ ë ˆì´ì•„ì›ƒ */
        .controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(3, 65px);
            grid-template-rows: repeat(2, 65px);
            gap: 12px;
            justify-content: center;
        }

        .ctrl-btn {
            width: 65px; height: 65px;
            background-color: #5d6d7e;
            border: none; border-radius: 12px;
            color: white; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            user-select: none;
            cursor: pointer;
            box-shadow: 0 4px #2c3e50;
        }
        .ctrl-btn:active { 
            background-color: #2ecc71; 
            box-shadow: 0 2px #27ae60;
            transform: translateY(2px);
        }
        
        .btn-rotate { grid-column: 2; background-color: #3498db; } /* íšŒì „ ë²„íŠ¼ ê°•ì¡° */
        .btn-down { grid-row: 2; grid-column: 2; }
        .btn-drop { background-color: #e74c3c; grid-row: 2; grid-column: 3; font-size: 18px; }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95); padding: 25px; border-radius: 15px;
            text-align: center; z-index: 100; min-width: 250px; border: 2px solid #2980b9;
        }
        .hidden { display: none !important; }
        input { padding: 12px; width: 80%; margin-bottom: 15px; border-radius: 5px; border: none; outline: none; font-size: 16px; }
        button.main-btn { padding: 12px 25px; background-color: #2ecc71; border: none; color: white; border-radius: 5px; font-weight: bold; cursor: pointer; }

        .rank-list { text-align: left; margin: 15px 0; max-height: 180px; overflow-y: auto; font-size: 14px; }
    </style>
</head>
<body>

    <div class="game-container">
        <div id="game-board"></div>

        <div class="info-panel">
            <h2 class="game-title">ì¡°ì†Œí˜„ì˜<br>í…ŒíŠ¸ë¦¬ìŠ¤</h2>
            <div style="background:#2c3e50; padding:8px; border-radius:5px; border-left: 3px solid #f1c40f;">
                <p style="margin:2px 0;">Score: <b id="score" style="color:#f1c40f;">0</b></p>
                <p style="margin:2px 0;"><small id="display-name">-</small></p>
            </div>
            <p style="margin:5px 0 2px 0;">Next Piece:</p>
            <div id="next-block"></div>
            <button id="rank-btn" style="background:#34495e; border:1px solid #7f8c8d; color:white; font-size:12px; padding:6px; margin-top:10px; cursor:pointer; width: 100%;">Ranking</button>
        </div>

        <div id="start-modal" class="modal">
            <h2 style="color:#2ecc71;">ì¡°ì†Œí˜„ì˜ í…ŒíŠ¸ë¦¬ìŠ¤</h2>
            <input type="text" id="player-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="8">
            <br>
            <button id="start-btn" class="main-btn">ê²Œì„ ì‹œì‘</button>
        </div>

        <div id="rank-modal" class="modal hidden">
            <h3>ğŸ† Top 10</h3>
            <div id="rank-content" class="rank-list"></div>
            <button id="close-rank" class="main-btn">ë‹«ê¸°</button>
        </div>

        <div id="game-over-modal" class="modal hidden">
            <h2 style="color:#e74c3c;">Game Over</h2>
            <p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></p>
            <button id="restart-btn" class="main-btn">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn btn-rotate" id="ctrl-up" title="íšŒì „">â†»</button>
        <button class="ctrl-btn" id="ctrl-left" title="ì™¼ìª½">â†</button>
        <button class="ctrl-btn btn-down" id="ctrl-down" title="ì•„ë˜">â†“</button>
        <button class="ctrl-btn" id="ctrl-right" title="ì˜¤ë¥¸ìª½">â†’</button>
        <button class="ctrl-btn btn-drop" id="ctrl-space" title="ì¦‰ì‹œ ë‚™í•˜">DROP</button>
    </div>

    <script>
        const ROWS = 20, COLS = 10;
        const TETROMINOES = {
            'I': [[0,0,0,0], [1,1,1,1], [0,0,0,0], [0,0,0,0]],
            'J': [[1,0,0], [1,1,1], [0,0,0]],
            'L': [[0,0,1], [1,1,1], [0,0,0]],
            'O': [[1,1], [1,1]],
            'S': [[0,1,1], [1,1,0], [0,0,0]],
            'T': [[0,1,0], [1,1,1], [0,0,0]],
            'Z': [[1,1,0], [0,1,1], [0,0,0]]
        };

        let board = [], currentPiece = null, nextPieceType = null;
        let score = 0, gameInterval = null, playerName = "";

        function init() {
            board = Array(ROWS).fill(0).map(() => Array(COLS).fill(0));
            const boardEl = document.getElementById('game-board');
            boardEl.innerHTML = '';
            for(let i=0; i<ROWS*COLS; i++) boardEl.appendChild(document.createElement('div')).classList.add('block');
            
            const nextEl = document.getElementById('next-block');
            nextEl.innerHTML = '';
            for(let i=0; i<16; i++) nextEl.appendChild(document.createElement('div')).classList.add('next-cell');
        }

        function createPiece() {
            const type = nextPieceType || Object.keys(TETROMINOES)[Math.floor(Math.random()*7)];
            nextPieceType = Object.keys(TETROMINOES)[Math.floor(Math.random()*7)];
            currentPiece = {
                type: type,
                shape: TETROMINOES[type],
                x: Math.floor(COLS/2) - Math.floor(TETROMINOES[type][0].length/2),
                y: 0
            };
            drawNext();
            if(collide()) return false;
            return true;
        }

        function collide(nx = 0, ny = 0, newShape = null) {
            const shape = newShape || currentPiece.shape;
            for(let r=0; r<shape.length; r++) {
                for(let c=0; c<shape[r].length; c++) {
                    if(shape[r][c]) {
                        let targetX = currentPiece.x + c + nx;
                        let targetY = currentPiece.y + r + ny;
                        if(targetX < 0 || targetX >= COLS || targetY >= ROWS || (targetY >= 0 && board[targetY][targetX])) return true;
                    }
                }
            }
            return false;
        }

        function lock() {
            currentPiece.shape.forEach((row, r) => {
                row.forEach((val, c) => {
                    if(val && currentPiece.y + r >= 0) board[currentPiece.y + r][currentPiece.x + c] = currentPiece.type;
                });
            });
            clearLines();
            if(!createPiece()) gameOver();
        }

        function clearLines() {
            let rowsCleared = 0;
            for(let r = ROWS - 1; r >= 0; r--) {
                if(board[r].every(cell => cell !== 0)) {
                    board.splice(r, 1);
                    board.unshift(Array(COLS).fill(0));
                    rowsCleared++;
                    r++;
                }
            }
            if(rowsCleared > 0) {
                score += [0, 100, 300, 500, 800][rowsCleared];
                document.getElementById('score').textContent = score;
            }
        }

        function draw() {
            const cells = document.querySelectorAll('#game-board .block');
            board.forEach((row, r) => {
                row.forEach((val, c) => {
                    const cell = cells[r * COLS + c];
                    cell.className = 'block' + (val ? ' ' + val : '');
                });
            });
            if(currentPiece) {
                currentPiece.shape.forEach((row, r) => {
                    row.forEach((val, c) => {
                        if(val) {
                            const idx = (currentPiece.y + r) * COLS + (currentPiece.x + c);
                            if(idx >= 0 && idx < cells.length) cells[idx].className = 'block ' + currentPiece.type;
                        }
                    });
                });
            }
        }

        function drawNext() {
            const cells = document.querySelectorAll('.next-cell');
            cells.forEach(c => c.className = 'next-cell');
            const shape = TETROMINOES[nextPieceType];
            shape.forEach((row, r) => {
                row.forEach((val, c) => {
                    if(val) {
                        const idx = (r + (nextPieceType==='I'?0:1)) * 4 + (c + (nextPieceType==='I'?0:1));
                        if(cells[idx]) cells[idx].className = 'next-cell ' + nextPieceType;
                    }
                });
            });
        }

        // --- ì¡°ì‘ í•µì‹¬ í•¨ìˆ˜ ---
        function moveLeft() { if(!collide(-1, 0)) { currentPiece.x--; draw(); } }
        function moveRight() { if(!collide(1, 0)) { currentPiece.x++; draw(); } }
        function moveDown() { if(!collide(0, 1)) { currentPiece.y++; draw(); } else { lock(); draw(); } }
        function rotate() {
            const rotated = currentPiece.shape[0].map((_, i) => currentPiece.shape.map(row => row[i]).reverse());
            if(!collide(0, 0, rotated)) { currentPiece.shape = rotated; draw(); }
        }
        function hardDrop() {
            while(!collide(0, 1)) currentPiece.y++;
            lock(); draw();
        }

        function handleRanking() {
            let ranks = JSON.parse(localStorage.getItem('tetrisRank') || '[]');
            ranks.push({ name: playerName, score: score });
            ranks.sort((a,b) => b.score - a.score);
            localStorage.setItem('tetrisRank', JSON.stringify(ranks.slice(0, 10)));
        }

        function showRank() {
            const ranks = JSON.parse(localStorage.getItem('tetrisRank') || '[]');
            const content = document.getElementById('rank-content');
            content.innerHTML = ranks.map((r, i) => `
                <div class="rank-item"><span>${i+1}. ${r.name}</span><span>${r.score}</span></div>
            `).join('') || "ê¸°ë¡ ì—†ìŒ";
            document.getElementById('rank-modal').classList.remove('hidden');
        }

        function gameOver() {
            clearInterval(gameInterval);
            gameInterval = null;
            handleRanking();
            document.getElementById('final-score').textContent = score;
            document.getElementById('game-over-modal').classList.remove('hidden');
        }

        function startGame() {
            const nameInput = document.getElementById('player-name').value.trim();
            if(!nameInput) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            playerName = nameInput;
            document.getElementById('display-name').textContent = playerName;
            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('game-over-modal').classList.add('hidden');
            
            score = 0;
            document.getElementById('score').textContent = "0";
            nextPieceType = null;
            
            if(gameInterval) clearInterval(gameInterval);
            init();
            createPiece();
            
            gameInterval = setInterval(() => {
                moveDown();
            }, 800);
        }

        // --- 1. í‚¤ë³´ë“œ ì¡°ì‘ ê¸°ëŠ¥ ---
        window.addEventListener('keydown', e => {
            if(!gameInterval) return;
            
            // ë°©í–¥í‚¤ ì…ë ¥ ì‹œ í™”ë©´ì´ ë°€ë¦¬ëŠ” í˜„ìƒ ë°©ì§€
            if(["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) {
                e.preventDefault();
            }

            switch(e.key) {
                case 'ArrowLeft': moveLeft(); break;
                case 'ArrowRight': moveRight(); break;
                case 'ArrowDown': moveDown(); break;
                case 'ArrowUp': rotate(); break;
                case ' ': hardDrop(); break;
            }
        });

        // --- 2. í”„ë¡œê·¸ë¨ ë‚´ ë²„íŠ¼ ì¡°ì‘ ê¸°ëŠ¥ (í„°ì¹˜/í´ë¦­ ëª¨ë‘ ì§€ì›) ---
        const controlsMap = {
            'ctrl-left': moveLeft,
            'ctrl-right': moveRight,
            'ctrl-down': moveDown,
            'ctrl-up': rotate,
            'ctrl-space': hardDrop
        };

        Object.keys(controlsMap).forEach(id => {
            const btn = document.getElementById(id);
            
            // í„°ì¹˜ ì‹œì‘ ì‹œ ì¦‰ì‹œ ì‹¤í–‰ (ëª¨ë°”ì¼ ìµœì í™”)
            btn.addEventListener('touchstart', e => {
                e.preventDefault();
                if(gameInterval) controlsMap[id]();
            });

            // ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ ì‹¤í–‰ (PCìš©)
            btn.addEventListener('mousedown', e => {
                e.preventDefault();
                if(gameInterval) controlsMap[id]();
            });
        });

        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('rank-btn').addEventListener('click', showRank);
        document.getElementById('close-rank').addEventListener('click', () => document.getElementById('rank-modal').classList.add('hidden'));
        
        document.getElementById('restart-btn').addEventListener('click', () => {
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('start-modal').classList.remove('hidden');
        });

        init();
    </script>
</body>
</html>
