
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>조소현의 테트리스 - 컨트롤 완벽 수정</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; background-color: #2c3e50; color: #ecf0f1;
            overflow: hidden; touch-action: none; /* 화면 전체 스크롤 및 줌 방지 */
        }

        .game-container {
            display: flex; gap: 15px; padding: 15px; border-radius: 10px;
            background-color: #34495e; box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            position: relative; z-index: 10;
        }

        #game-board {
            --cell-size: min(25px, 6vw);
            width: calc(var(--cell-size) * 10); height: calc(var(--cell-size) * 20);
            border: 4px solid #2980b9; background-color: #1c2833;
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(20, 1fr);
        }

        .block { box-sizing: border-box; border: 1px solid rgba(255,255,255,0.05); }
        .I { background-color: #00FFFF; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .O { background-color: #FFFF00; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .T { background-color: #800080; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .S { background-color: #00FF00; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .Z { background-color: #FF0000; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .J { background-color: #0000FF; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .L { background-color: #FF7F00; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }

        .info-panel { width: 100px; display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
        #next-block {
            width: 60px; height: 60px; display: grid; 
            grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
            border: 2px solid #5499c7; background-color: #1c2833;
        }
        .next-cell { border: 1px solid rgba(255,255,255,0.05); }

        /* 하단 컨트롤러 - 터치 영역 확보 */
        .controls {
            margin-top: 25px; display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(2, 70px);
            gap: 15px; justify-content: center;
            z-index: 20; position: relative;
        }

        .ctrl-btn {
            width: 70px; height: 70px; background-color: #5d6d7e;
            border: none; border-radius: 15px; color: white;
            font-size: 28px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 5px #2c3e50;
            pointer-events: auto; /* 버튼 클릭 강제 허용 */
        }
        .ctrl-btn:active {
            transform: translateY(4px); box-shadow: 0 2px #2c3e50;
            background-color: #3498db;
        }
        .btn-rotate { grid-column: 2; background-color: #2980b9; }
        .btn-drop { background-color: #e74c3c; grid-row: 2; grid-column: 3; font-size: 16px; }

        .modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95); padding: 25px; border-radius: 15px;
            text-align: center; z-index: 100; min-width: 260px; border: 2px solid #2980b9;
        }
        .hidden { display: none !important; }
        button.main-btn { padding: 12px 25px; background-color: #2ecc71; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="game-container">
        <div id="game-board"></div>
        <div class="info-panel">
            <h3 style="margin:0; color:#f1c40f;">조소현</h3>
            <div style="background:#2c3e50; padding:8px; border-radius:5px;">
                Score: <b id="score">0</b>
            </div>
            <p style="margin:5px 0 0 0;">Next:</p>
            <div id="next-block"></div>
        </div>

        <div id="start-modal" class="modal">
            <h2>TETRIS</h2>
            <input type="text" id="player-name" placeholder="닉네임" maxlength="8" style="padding:10px; margin-bottom:15px; width:80%;">
            <br>
            <button id="start-btn" class="main-btn">게임 시작</button>
        </div>

        <div id="game-over-modal" class="modal hidden">
            <h2 style="color:#e74c3c;">Game Over</h2>
            <p>점수: <span id="final-score">0</span></p>
            <button id="restart-btn" class="main-btn">다시 하기</button>
        </div>
    </div>

    <div class="controls">
        <div class="ctrl-btn btn-rotate" id="ctrl-up">↻</div>
        <div class="ctrl-btn" id="ctrl-left">←</div>
        <div class="ctrl-btn" id="ctrl-down">↓</div>
        <div class="ctrl-btn" id="ctrl-right">→</div>
        <div class="ctrl-btn btn-drop" id="ctrl-space">DROP</div>
    </div>

    <script>
        const ROWS = 20, COLS = 10;
        const TETROMINOES = {
            'I': [[0,0,0,0], [1,1,1,1], [0,0,0,0], [0,0,0,0]],
            'J': [[1,0,0], [1,1,1], [0,0,0]],
            'L': [[0,0,1], [1,1,1], [0,0,0]],
            'O': [[1,1], [1,1]],
            'S': [[0,1,1], [1,1,0], [0,0,0]],
            'T': [[0,1,0], [1,1,1], [0,0,0]],
            'Z': [[1,1,0], [0,1,1], [0,0,0]]
        };

        let board = [], currentPiece = null, nextPieceType = null;
        let score = 0, gameInterval = null;

        function init() {
            board = Array(ROWS).fill(0).map(() => Array(COLS).fill(0));
            const boardEl = document.getElementById('game-board');
            boardEl.innerHTML = '';
            for(let i=0; i<ROWS*COLS; i++) boardEl.appendChild(document.createElement('div')).classList.add('block');
        }

        function createPiece() {
            const types = Object.keys(TETROMINOES);
            const type = nextPieceType || types[Math.floor(Math.random()*types.length)];
            nextPieceType = types[Math.floor(Math.random()*types.length)];
            currentPiece = { type, shape: TETROMINOES[type], x: 3, y: 0 };
            drawNext();
            if(collide()) return false;
            return true;
        }

        function collide(nx=0, ny=0, newShape=null) {
            const shape = newShape || currentPiece.shape;
            for(let r=0; r<shape.length; r++) {
                for(let c=0; c<shape[r].length; c++) {
                    if(shape[r][c]) {
                        let tx = currentPiece.x + c + nx, ty = currentPiece.y + r + ny;
                        if(tx<0 || tx>=COLS || ty>=ROWS || (ty>=0 && board[ty][tx])) return true;
                    }
                }
            }
            return false;
        }

        function rotate() {
            const rotated = currentPiece.shape[0].map((_, i) => currentPiece.shape.map(row => row[i]).reverse());
            if(!collide(0, 0, rotated)) { currentPiece.shape = rotated; draw(); }
        }

        function moveDown() {
            if(!collide(0, 1)) { currentPiece.y++; draw(); }
            else { lock(); }
        }

        function lock() {
            currentPiece.shape.forEach((row, r) => {
                row.forEach((val, c) => {
                    if(val && currentPiece.y+r>=0) board[currentPiece.y+r][currentPiece.x+c] = currentPiece.type;
                });
            });
            clearLines();
            if(!createPiece()) {
                clearInterval(gameInterval);
                gameInterval = null;
                document.getElementById('final-score').innerText = score;
                document.getElementById('game-over-modal').classList.remove('hidden');
            }
            draw();
        }

        function clearLines() {
            for(let r=ROWS-1; r>=0; r--) {
                if(board[r].every(cell => cell !== 0)) {
                    board.splice(r, 1);
                    board.unshift(Array(COLS).fill(0));
                    score += 100; r++;
                }
            }
            document.getElementById('score').innerText = score;
        }

        function draw() {
            const cells = document.querySelectorAll('#game-board .block');
            cells.forEach(c => c.className = 'block');
            board.forEach((row, r) => row.forEach((val, c) => {
                if(val) cells[r*COLS+c].classList.add(val);
            }));
            if(currentPiece) {
                currentPiece.shape.forEach((row, r) => row.forEach((val, c) => {
                    if(val && currentPiece.y+r>=0) cells[(currentPiece.y+r)*COLS+(currentPiece.x+c)].classList.add(currentPiece.type);
                }));
            }
        }

        function drawNext() {
            const cells = document.querySelectorAll('#next-block div');
            if(cells.length === 0) {
                const nb = document.getElementById('next-block');
                for(let i=0; i<16; i++) nb.appendChild(document.createElement('div')).className='next-cell';
            }
            const nextCells = document.querySelectorAll('.next-cell');
            nextCells.forEach(c => c.className = 'next-cell');
            TETROMINOES[nextPieceType].forEach((row, r) => row.forEach((val, c) => {
                if(val) nextCells[r*4+c].classList.add(nextPieceType);
            }));
        }

        // --- 조작 이벤트 바인딩 ---
        function handleInput(action) {
            if(!gameInterval) return;
            if(action === 'left' && !collide(-1, 0)) currentPiece.x--;
            if(action === 'right' && !collide(1, 0)) currentPiece.x++;
            if(action === 'down') moveDown();
            if(action === 'up') rotate();
            if(action === 'drop') { while(!collide(0, 1)) currentPiece.y++; lock(); }
            draw();
        }

        // 버튼 직접 연결 (클릭 & 터치)
        const btnMap = {
            'ctrl-left': 'left', 'ctrl-right': 'right', 
            'ctrl-down': 'down', 'ctrl-up': 'up', 'ctrl-space': 'drop'
        };

        Object.keys(btnMap).forEach(id => {
            const el = document.getElementById(id);
            // 모바일 터치 대응
            el.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(btnMap[id]); }, {passive: false});
            // PC 클릭 대응
            el.addEventListener('mousedown', (e) => { e.preventDefault(); handleInput(btnMap[id]); });
        });

        // 키보드 대응
        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowLeft') handleInput('left');
            if(e.key === 'ArrowRight') handleInput('right');
            if(e.key === 'ArrowDown') handleInput('down');
            if(e.key === 'ArrowUp') handleInput('up');
            if(e.key === ' ') handleInput('drop');
        });

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('start-modal').classList.add('hidden');
            score = 0; document.getElementById('score').innerText = '0';
            init(); createPiece(); draw();
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(moveDown, 800);
        };

        document.getElementById('restart-btn').onclick = () => {
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('start-modal').classList.remove('hidden');
        };

        init();
    </script>
</body>
</html>
